<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Iniciar sesión | Academia de Programación</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans min-h-screen flex flex-col">

  <!-- Navbar -->
  <header class="bg-white px-8 py-4 flex justify-between items-center border-b border-gray-200 shadow-sm">
    <div class="text-xl font-bold text-gray-900">Academia</div>
    <nav class="space-x-4 flex items-center" id="nav-links">
      <a href="/" class="text-gray-800 hover:text-blue-600">Inicio</a>
      <a href="/cursos" class="text-gray-800 hover:text-blue-600">Cursos</a>

      <!-- Botones de login/registro -->
      <a href="/login" id="login-link" class="px-4 py-2 border border-gray-800 rounded font-semibold hover:bg-gray-100 transition">Iniciar sesión</a>
      <a href="/register" id="register-link" class="px-4 py-2 bg-black text-white rounded font-semibold hover:bg-gray-900 transition">Registrarse</a>

      <!-- Menú perfil -->
      <div id="perfil-wrapper" class="relative hidden">
        <button id="perfil-btn" class="w-10 h-10 bg-purple-600 text-white font-semibold rounded-full flex items-center justify-center uppercase focus:outline-none">
          <span id="perfil-inicial">U</span>
        </button>
        <div id="perfil-dropdown" class="absolute right-0 mt-2 w-44 bg-white border rounded shadow-md hidden z-10">
          <a href="/perfil" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mi perfil</a>
          <a href="/mis-cursos" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mis cursos</a>
          <button onclick="logout()" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Cerrar sesión</button>
        </div>
      </div>
    </nav>
  </header>

  <!-- Hero -->
  <section class="text-center py-12 bg-white shadow-sm">
    <h1 class="text-4xl font-bold mb-2">Iniciar sesión</h1>
    <p class="text-lg text-gray-600">Ingresa tus datos para acceder a tu cuenta</p>
  </section>

  <!-- Formulario de Login -->
  <main class="flex-grow container mx-auto px-4 py-8 max-w-md">
    <div id="error-msg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"></div>

    <form id="login-form" class="bg-white p-6 rounded shadow space-y-6">
      <div>
        <label for="username" class="block font-medium mb-1">Correo electrónico:</label>
        <input type="email" id="username" name="username" required class="w-full border border-gray-300 rounded px-3 py-2">
      </div>

      <div>
        <label for="password" class="block font-medium mb-1">Contraseña:</label>
        <input type="password" id="password" name="password" required class="w-full border border-gray-300 rounded px-3 py-2">
      </div>

      <div class="flex items-center">
        <input type="checkbox" id="remember" name="remember" class="mr-2">
        <label for="remember" class="text-sm text-gray-700">Mantener sesión iniciada</label>
      </div>

      <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded font-semibold hover:bg-blue-700 transition">Iniciar sesión</button>
    </form>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-200 text-center text-sm text-gray-600 py-4 mt-auto">
    &copy; 2025 Academia. Todos los derechos reservados.
  </footer>

  <script>
    const API_URL = "http://localhost:8000";

    // Función para obtener el token almacenado
    function getToken() {
      return localStorage.getItem("token");
    }

    // Función para cerrar sesión
    function logout() {
      localStorage.removeItem("token");
      sessionStorage.removeItem("remember_session");
      window.location.href = '/';
    }

    // Función para mostrar errores
    function mostrarError(mensaje) {
      const errorMsg = document.getElementById("error-msg");
      if (errorMsg) {
        errorMsg.textContent = mensaje;
        errorMsg.classList.remove("hidden");
      }
    }

    // Función para obtener el ID del rol del usuario
    function obtenerIdRol(userData) {
      if (userData.id_rol !== undefined) return userData.id_rol;
      if (userData.rol && userData.rol.id !== undefined) return userData.rol.id;
      if (userData.usuario && userData.usuario.id_rol !== undefined) return userData.usuario.id_rol;
      return null;
    }

    // Configura el manejo del formulario de login
    document.addEventListener("DOMContentLoaded", () => {
      const loginForm = document.getElementById("login-form");
      
      // Si hay un token, verifica si debe redirigir
      const token = getToken();
      if (token) {
        console.log("Token encontrado, verificando con el servidor...");
        
        fetch(`${API_URL}/usuarios/me`, {
          headers: { Authorization: `Bearer ${token}` }
        })
        .then(res => {
          if (res.ok) {
            return res.json();
          } else {
            console.log("Token inválido");
            localStorage.removeItem("token");
            return null;
          }
        })
        .then(userData => {
          if (userData) {
            const rolId = obtenerIdRol(userData);
            if (rolId) {
              // Redirige según el rol
              redirigirSegunRol(rolId);
            }
          }
        })
        .catch(error => {
          console.error("Error:", error);
        });
      }
      
      // Maneja el evento de envío del formulario
      loginForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;
        const remember = document.getElementById("remember").checked;
        
        try {
          // Envía la solicitud de login
          const res = await fetch(`${API_URL}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ username, password }),
          });
          
          if (res.ok) {
            const data = await res.json();
            
            // Guarda el token
            localStorage.setItem("token", data.access_token);
            
            if (remember) {
              sessionStorage.setItem("remember_session", "true");
            }
            
            // Establece también como cookie (por si el backend lo busca ahí)
            document.cookie = `access_token=${data.access_token}; path=/; SameSite=Strict`;
            
            // Obtén el ID del rol
            const rolId = obtenerIdRol(data);
            
            if (rolId !== null) {
              // Guarda el rol
              localStorage.setItem("user_role", rolId.toString());
              
              // Redirige según el rol
              redirigirSegunRol(rolId);
            } else {
              mostrarError("No se pudo determinar tu rol de usuario");
            }
          } else {
            const errorData = await res.json();
            mostrarError(errorData.detail || "Credenciales incorrectas");
          }
        } catch (error) {
          mostrarError("Error de conexión");
        }
      });
    });
    
    // Función para redirigir según el rol del usuario
    function redirigirSegunRol(id_rol) {
      const rolId = parseInt(id_rol, 10);
      console.log("Redirigiendo al rol:", rolId);
      
      if (isNaN(rolId)) {
        mostrarError("ID de rol no válido");
        return;
      }
      
      // Determina la URL según el rol
      let targetUrl;
      switch (rolId) {
        case 1:
          targetUrl = '/super';
          break;
        case 2:
          targetUrl = '/admin';
          break;
        case 3:
          targetUrl = '/';
          break;
        default:
          targetUrl = '/';
          break;
      }
      
      // Redirige a la URL
      window.location.href = targetUrl;
    }
  </script>
</body>
</html>